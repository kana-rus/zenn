---
title: "ã‚¿ãƒ¼ãƒŸãƒŠãƒ«é¢¨ãƒ­ã‚°ã‚¤ãƒ³æ©Ÿèƒ½ã‚’ä½œã£ãŸè©±"
emoji: "ğŸ¦”"
type: "tech"
topics: ["html", "JavaScript", "Go"]
published: false
---
## å…ˆæ—¥ã€
å¤§å­¦ã®èª²é¡Œã§ (ç°¡å˜ãª) è‡ªå·±ç´¹ä»‹ãƒšãƒ¼ã‚¸ã‚’ä½œã£ã¦å…¬é–‹ã™ã‚‹ã¨ã„ã†ã‚‚ã®ãŒå‡ºã•ã‚Œã¾ã—ãŸã€‚ä»Šæ€ãˆã°ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã•ã‚Œãªã„ã‚ˆã†ã«ã™ã‚Œã°ã„ã„è©±ãªã®ã§ã™ãŒã€å½“æ™‚ã¯ãã®ç™ºæƒ³ãŒãªãã€å€‹äººæƒ…å ±ä¿è­·ã‚’ã©ã†å®Ÿç¾ã™ã‚‹ã‹ã¨ã„ã†ã“ã¨ã§~~ãã®ã¤ã„ã§ã«ã©ã‚“ãªæŠ€è¡“ã‚’å‹‰å¼·ã—ã‚ˆã†ã‹ã¨ãƒ¯ã‚¯ãƒ¯ã‚¯ã—ã¦~~é ­ãŒã„ã£ã±ã„ã§ã—ãŸã€‚
:::message
ã€Œhtmlãƒ•ã‚¡ã‚¤ãƒ«ã‚’æå‡ºã™ã‚‹ã€ã¨ã„ã†è¦ä»¶ãŒã‚ã£ãŸãŸã‚ã€èª²é¡Œã®è¶£æ—¨ã‹ã‚‰ã™ã‚‹ã¨100%è‡ªåˆ†ã§ç›´æ¥æ›¸ã„ãŸhtmlãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‡ºã™ã¹ãã ã‚ã†ã¨è€ƒãˆã¦ index.html ã‚’ç›´æ›¸ãã—ãŸã®ã§ã€ä»¥ä¸‹TypeScriptã§ã¯ãªãJavaScriptãŒç™»å ´ã—ã¾ã™ã€‚
:::
æœ€çµ‚çš„ã«ãƒ­ã‚°ã‚¤ãƒ³æ©Ÿèƒ½ã‚’ã¤ãã‚‹ã“ã¨ã«ã—ã¾ã—ãŸã€‚ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã®ãƒ‡ã‚¶ã‚¤ãƒ³ã¨ã—ã¦ã¯ã€ä»¥å‰ã‹ã‚‰æ¸©ã‚ã¦ã„ãŸã‚¿ãƒ¼ãƒŸãƒŠãƒ«é¢¨`textarea`ã¨ã„ã†ã‚¢ã‚¤ãƒ‡ã‚¢ã‚’æ¡ç”¨ã—ã¾ã—ãŸã€‚ãƒ­ã‚°ã‚¤ãƒ³å‡¦ç†ã®æµã‚Œã¯ä»¥ä¸‹ã®é€šã‚Šã§ã™ã€‚

```mermaid
sequenceDiagram
participant front
participant API
front->>API: POST({"command": "INPUT_COMMAND"})
Note right of API: verify INPUT_COMMAND
API->>front: self-introduction-content if OK
API->>front: empty data if not OK
Note left of front: login if OK
```

## å®Ÿéš›ã«å‹•ãã‚‚ã®
ã‚’ã“ã“ã«ç½®ã„ã¦ãŠãã¾ã™ã€‚ãƒ›ã‚¹ãƒˆå…ˆã«ã¯ä½¿ã„æ…£ã‚ŒãŸVercelã‚’æ¡ç”¨ã—ã¾ã—ãŸã€‚
https://self-introduction-osz2aqgry-kana-rus.vercel.app
/*
Heroku ã® CofigVarsã€€ã®ã€ç‰¹ã« MY_NAME ã‚’æ›¸ãæ›ãˆã¦ãŠã
*/

html ã¯ä»¥ä¸‹ã®é€šã‚Šã§ã™ (å†—é•·ã«ãªã‚‰ãªã„ã‚ˆã†ã€CSS ã¯èª¬æ˜ã«å¿…è¦ãªéƒ¨åˆ†ä»¥å¤–çœç•¥ã—ã¾ã™)ã€‚

```html:index.html
<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>è‡ªå·±ç´¹ä»‹</title>
  <style>
    .login-modal {
        position: absolute;
        width: 100%;
        height: 100%;
        transform: translateX(-1.5px) translateY(-1px);
        /* åŸå› ä¸æ˜ã®éš™é–“ã¸ã®æš«å®šå¯¾ç­– */
        
        border: solid;
        background-color: black;
        outline: none;

        padding: 5%;
        color: azure;
        font-size: 1.6em;
    }
    main {
        display: none; /* default */
    }

    <!--ç•¥-->

  </style>
</head>
<body onload="handleLoginCache()">
  <textarea class="login-modal" oninput="checkInput()"></textarea>
  <main>
    <div class="header">
      <div class="title-column">
        <div class="title">
          <p class="title-line">è‡ªå·±</p>
          <p class="title-line">ç´¹ä»‹</p>
        </div>
      </div>
      <div class="name-column">
        <p class="my-name"></p>
      </div>
    </div>
    <span>
      <div class="card background-card">
        <h2 class="card-title">æ¥æ­´</h2>
        <ul class="card-ul">
        </ul>
      </div>
      <div class="card hobby-card">
        <h2 class="card-title">è¶£å‘³</h2>
        <ul class="card-ul">
        </ul>
      </div>
    </span>
  </main>
  <script>
    const apiURL = 'https://selfintroduction-loginapi.herokuapp.com/'
    const strageKeyBody = 'SelfIntroduction'
    const devLoginCommand = 'login --dev'

    const loginModal = document.getElementsByTagName('textarea')[0]
    const mainElement = document.getElementsByTagName('main')[0]
    const myNameArea = document.getElementsByTagName('p')[2]
    const ulElems = document.getElementsByTagName('ul')
    const backgroundUl = ulElems[0]
    const hobbyUl = ulElems[1]

    let pastInputLen = 0

    function handleLoginCache() {
      let loginMemory = checkStrage('loggedin')
      if (loginMemory==='yes') {
        loginWith(
          checkStrage('myname'),
          checkStrage('background').split(','),
          checkStrage('hobby').split(',')
        )
      } 
    }
    function checkInput() {
      const allInputCommands = loginModal.value
      const inputCommand = allInputCommands.slice(pastInputLen)
      if (inputCommand.slice(-1)==='\n') {
        verify({ command: inputCommand.slice(0, -1) })
         .then(res => {
           if (res["loggedin"] === 'yes') {
             loginWith(res["myname"], res["background"], res["hobby"])
             Object.keys(res).forEach(keyName => {
               sessionStorage.setItem(strageKeyBody+keyName, res[keyName])
               /*
               ã“ã“ã§ã€sesssionStrage ã® value ã¯ string ã—ã‹è¨±ã•ã‚Œãªã„ãŸã‚ã€
               é…åˆ—ã¯è‡ªå‹•çš„ã« csv å½¢å¼ã®æ–‡å­—åˆ—ã«å¤‰æ›ã•ã‚Œã¦æ ¼ç´ã•ã‚Œã‚‹
               */
             })
           } else {
             pastInputLen = allInputCommands.length
           }
         })
      }
    }

    function checkStrage(key) {
      return sessionStorage.getItem(strageKeyBody+key)
    }
    async function verify(data) {
      const responseBody = await fetch(apiURL, {
        method: 'POST',
        body: JSON.stringify(data)
      })
      return responseBody.json()
    }
    function loginWith(myName, backgroundData, hobbyData) {
      myNameArea.appendChild(document.createTextNode(myName))
      backgroundData.forEach(bg => {
        newBackgroundLi = document.createElement('li')
        newBackgroundLi.appendChild(document.createTextNode(bg))
        backgroundUl.appendChild(newBackgroundLi)
      })
      hobbyData.forEach(hb => {
        newHobbyLi = document.createElement('li')
        newHobbyLi.appendChild(document.createTextNode(hb))
        hobbyUl.appendChild(newHobbyLi)
      })
      login()
    }
    function login() {
      loginModal.style.display = 'none'
      mainElement.style.display = 'initial'
    }
  </script>
</body>
</html>
```
å‘½åã«ã¤ã„ã¦
- `res["loggedin"]` -> `res["can_login"]`, `res["judge"]` ãªã©
- `backgroundData` -> `myBackgroundInfo`

ã¨ã‹ã€å®Ÿè£…é¢ã§
- `loginWith()` ã‚’å‘¼ã³å‡ºã™å´ãŒå¼•æ•°ã”ã¨ã« `split` ã™ã‚‹ã‹ã—ãªã„ã‹åˆ¤æ–­ã—ãªã„ã¨ã„ã‘ãªããªã£ã¦ã„ã‚‹

ã¨ã„ã£ãŸæå‡ºæ—¥ã«è¿½ã‚ã‚Œã¦ç›´ã›ãªã‹ã£ãŸå•é¡Œç‚¹ãŒæ®‹ã£ã¦ã„ã‚‹ã®ã§ã€ã“ã®è¨˜äº‹ãŒèª­ã¾ã‚Œã‚‹æ™‚ç‚¹ã§ã¯ã‹ãªã‚Šé•ã£ãŸã‚³ãƒ¼ãƒ‰ã«ãªã£ã¦ã„ã‚‹ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚

/*
pastInputLen ã¨ã‹ login() ã¨ã‹ã®èª¬æ˜
*/

## APIå´
ã¯Goã§æ›¸ã„ã¦ã€Herokuã§ãƒ›ã‚¹ãƒˆ + GASã§å®šæœŸfetch ã—ã¦ã¾ã™ã€‚ä»Šå›å‹‰å¼·ã—ãŸã®ã¯ã“ã“ã§ã€å®Ÿã¯ä»Šã¾ã§

- requestã«ã‚ˆã£ã¦responseã‚’å¤‰ãˆã‚‹API
- `CORS`ãŒçµ¡ã‚€API

ã‚’è‡ªåˆ†ã§å®Ÿè£…ã—ãŸã“ã¨ãŒãªã‹ã£ãŸã®ã§ã€çµŒé¨“ã§ãã¦ã‚ˆã‹ã£ãŸã§ã™ã€‚ã‚³ãƒ¼ãƒ‰ã¯ä»¥ä¸‹ã®é€šã‚Šã§ã™ã€‚

```go:main.go
package main

import (
    "encoding/json"
    "fmt"
    "io/ioutil"
    "net/http"
    "os"
    "strings"
)

type requestType struct {
    Command string `json:"command"`
}
type responseType struct {
    LoggedIn     string `json:"loggedin"`
    MyName       string `json:"myname"`
    Background []string `json:"background"`
    Hobby      []string `json:"hobby"`
}

var (
    loginCommand   = os.Getenv("LOGIN_COMMAND")
    port           = os.Getenv("PORT")
    myName         = os.Getenv("MY_NAME")
    backgroundData = strings.Split(os.Getenv("BACKGROUND_CSV"), ",")
    hobbyData      = strings.Split(os.Getenv("HOBBY_CSV"), ",")
    applicationURL = "https://self-introduction-osz2aqgry-kana-rus.vercel.app"
)

func main() {
    http.HandleFunc("/", requestHandler)
    http.ListenAndServe(":"+port, nil)
}

func requestHandler(rw http.ResponseWriter, req *http.Request) {
    body, err := ioutil.ReadAll(req.Body)
    if err != nil {
    	http.Error(rw, err.Error(), http.StatusInternalServerError)
    	return
    }
    jsonBytes := body
    /*
    	ã“ã‚Œã¯ byte[] ãªã®ã§ã€ãŸã¨ãˆã°
    	    {"command":"login"}
    	ãªã‚‰
    	    [123 34 99 111 109 109 97 110 100 34 58 32 34 108 111 103 105 110 34 125]
    */
    inputCommand := string(jsonBytes[12:len(jsonBytes)-2])    
    var loggedInOrNot string
    if inputCommand == loginCommand {
    	loggedInOrNot = "yes"
    } else {
    	loggedInOrNot = "no"
    	myName = ""
    	backgroundData = nil
    	hobbyData = nil
    }
    response, err := json.Marshal(responseType{
    	LoggedIn: loggedInOrNot,
    	MyName: myName,
    	Background: backgroundData,
    	Hobby: hobbyData,
    })
    if err != nil {
    	http.Error(rw, err.Error(), http.StatusInternalServerError)
    	return
    }    
    rw.Header().Set("Access-Control-Allow-Origin", applicationURL)
    fmt.Fprintf(rw, "%v\n", string(response))
}
```
```js:main.gs
function awakeHeroku() {
  deletePastTriggers()
  setTrigger()
  UrlFetchApp.fetch('https://selfintroduction-loginapi.herokuapp.com/')
}

function deletePastTriggers() {
  const triggers = ScriptApp.getProjectTriggers()
  for (const trigger of triggers) {
    ScriptApp.deleteTrigger(trigger)
  }
}
function setTrigger() {
  let setTime = new Date()
  setTime.setMinutes(setTime.getMinutes() + 25)
  // ã“ã‚Œã§æ™‚ãƒ»æ—¥ã¸ã®ç¹°ã‚Šè¶Šã—ã‚‚å«ã‚ã¦å‡¦ç†ã—ã¦ãã‚Œã‚‹

  ScriptApp.newTrigger('awakeHeroku')
           .timeBased()
           .at(setTime)
           .create()
}
```
*GASã®ã‚·ãƒ³ã‚¿ãƒƒã‚¯ã‚¹ãƒã‚¤ãƒ©ã‚¤ãƒˆã¯ã€jsã‚³ãƒ¼ãƒ‰ã¨ã—ã¦èªè­˜ã•ã›ã‚‹ã“ã¨ã§æ“¬ä¼¼çš„ã«å®Ÿç¾ã—ã¦ã¾ã™*

<br>

ã©ã†ã›ã“ã†ãªã‚‹ãªã‚‰htmlç›´æ›¸ãç¸›ã‚Šã¯ã»ã¨ã‚“ã©æ„å‘³ãŒãªã‹ã£ãŸç­‰ã€å¾Œæ‚”ã¯è‰²ã€…ã‚ã‚Šã¾ã™ãŒã€å˜ç´”ãªãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ãƒ»ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰é–“ã®é€šä¿¡ã‚’è‡ªåˆ†ã®æ‰‹ã§å®Ÿè£…ã§ãã¦ã‚ˆã‹ã£ãŸã¨æ€ã£ã¦ã„ã¾ã™ã€‚æœ€å¾Œã¾ã§èª­ã‚“ã§ã„ãŸã ãã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã—ãŸã€‚